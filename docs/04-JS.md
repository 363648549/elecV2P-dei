```
最近更新： 2020-9-12
适用版本： 2.5.2
```

## 运行模式 - [vm](https://nodejs.org/api/vm.html)

``` JS
vm.runInNewContext(jscode, context)     // 默认 timeout 为 5 秒（这个限制对异步函数无效）
```

## context - JS 运行环境

类型：object

### 几个内置参数

``` 主要函数
- $axios           // 网络请求
- $store           // 数据保存
- $feed            // 通知模块
- $exec            // 简单 shell 命令执行
- $cheerio         // 网页处理
```

``` 附加变量
- __dirname        // process.cwd()。 以两个短下划线开头
- __home           // 主页地址。 在 webUI->setting 页面设置

// 测试 JS: console.log(__dirname, __home)
```

### $axios(request)

request 格式 [object/string]

- object：支持参数参考：[axios](https://github.com/axios/axios)
- string：单个 url 链接

``` JS
// --- example 1 ---
$axios('https://httpbin.org/get?hello=elecV2P').then(res=>console.log(res.data)).catch(e=>console.log(e))

// --- example 2 ---
$axios({
  url: 'https://httpbin.org/put',
  method: 'put',
  timeout: 6000,
  data: {
    hello: 'elecV2P'
  }
}).then(res=>console.log(res.data)).catch(e=>console.log(e))
```

* **$axios** 无 .put/.post 等方法，使用 { ..., method: 'put/post' } 实现*

**2.1.8 更新 $axios(request, proxy)**

增加第二个参数 proxy, 此参数会覆盖 request.proxy, 示例

``` JS
$axios(request, {
  host: '127.0.0.1',
  port: 9000,
  auth: {
    username: 'hello',
    password: 'elecV2P'
  }
})

// 当 proxy 设置为 true 时使用内部默认代理，false： 强制跳过使用代理，省略则使用默认设置。
// 其他设置参考 [axios](https://github.com/axios/axios) request/proxy 部分
```

proxy 默认设置 webUI setting -> eAxios 相关设置

### $store

常量/cookie 存储。所有存储值以文件的形式存储在 script/Store 目录

``` JS example
$store.get(key, type)          // 获取存储值
// type 可选
// - 'raw': 获取存储文件源内容
// - 'string/array/object/boolean/number': 以相应格式获取存储值

$store.put(value, key, type)   // 保存
// type 可选
// - 'a': 添加内容。具体参考下面的 JS 实例
// - 'string/array/object/boolean/number': 保存为对应格式

$store.delete(key)             // 删除
```

$store 保存时会对数据类型进行简单的判断，当数据类型为 **number/boolean/object** 时，会按照数据类型进行保存。

``` JS store 实例
$store.put(123, 'number')
typeof $store.get('number')    // 返回数字 123

$store.get('number', 'raw')   // 返回 { "type": "number", "value": 123}

$store.put([2,3,4], 'newarr')   // 存储为数组。保存成功返回 true，失败返回 false
$store.get('newarr')            // 返回数组：[2,3,4]

$store.put(5, 'newarr', 'a')
// 根据 newarr 原来保存值的类型，存储新的结果
// 原 newarr 值为 array 数组，保存值为：[2,3,4,5]
// 如果原 newarr 的值为数字，比如 8，则新的存储值 13
$store.put([6,7], 'newarr', 'a')   // newarr 新值为：[2,3,4,5,6,7]

$store.put('a string', 'keystr')   // string 类型的值直接按原值保存。即不会转化为 {type:'', value:''} 的形式
$store.put('add new line', 'keystr', 'a')   // 在原 keystr 的值后面添加新行
$store.get('keystr', 'raw')
// 返回：
// a string
// add new line

$store.put({a: 334, b: 'abc'}, 'keyobj')     // 存储类型为 object。
$store.get('keyobj')    // 返回：{"a":334,"b":"abc"}
$store.get('keyobj', 'raw')    // 返回：{"type":"object","value":{"a":334,"b":"abc"}}
$store.put({c: 'new val'}, 'keyobj', 'a')    // 新存储的值为：{"a":334,"b":"abc","c": "new val"}

$store.put('eoooe', 'keybol', 'boolean')     // 强制转化为 boolean 值：true
// 建议在使用 $store.put 并指定 type 的时候，先确定原存储数值和即将保存数值的类型，以免发生未知错误。

// 特殊情况
$store.put('a string 字符', 'objstr', 'object')   // 强制将字符串保存为 object 格式。存储值为：{0: "a string 字符"}。 PS: array 是同样结果
$store.get('keystr', 'array')  // 将字符串以 object 格式取出。结果为：{"0":"a string"}

// 2.5.2 更新 $store.get type random。 type 关键字 random 或者 r
$store.get('newarr', 'random')   // 返回 newarr 数组中的一个随机值
$store.get('number', 'r')        // 返回 0 - number 代表值 中间的任一整数
$store.get('keyobj', 'r')        // 返回 object 中的任一 keys 对应值
$store.get('keybol', 'random')   // 返回 随机 true/false
$store.get('keystr', 'r')        // 如果 keystr 存储的是字符串，取随机值时，取随机一行的数据
```

### $feed

- $feed.push(tile, description, url) - 添加一个 feed item

``` JS example
$feed.push('elecV2P notification', '这是一条来自 elecV2P 的通知', 'https://github.com/elecV2/elecV2P')
```

- $feed.ifttt(tile, description, url) - 发送一条 ifttt 通知

*先设置好 ifttt webhook key*

*url 可省略*

### $exec(command, { cwd, env, timeout, cb })

- cwd:       工作目录
- env:       环境变量
- timeout:   超时时间，单位：毫秒
- cb(data, error):    回调函数
  - data: stdout.on('data') 对应值
  - error: stderr.on('data') 对应值

``` JS example
$exec('ls', {
  timeout: 5000,
  cb(data, error){
    error ? console.error(error) : console.log(data)
  }
})
```

其他参考：[child_process_exec](https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback)

*如果命令不可执行，尝试先在系统命令行工具下手动输入命令，进行测试*

**如果 windows 平台出现乱码，尝试命令 *CHCP 65001* 或者将 windows console 设置为 utf-8**
*尝试过 iconv 转换(<1.8.2)，弃用*

### $cheerio

用于对 html 的处理

``` JS example
let body = $response.body
let restype = $response.headers['Content-Type']

if (/html/.test(restype)) {
  const $ = $cheerio.load(body)
  $('body').text('hello cheerio')
  body = $.html()
  console.log(body)
}

$done(body)
```

更多使用方法参考：[cheerio](https://github.com/cheeriojs/cheerio) 官方说明文档

### $request/$response

这两个参数只有在网络请求中匹配到对应 JS 才有效。

``` JS example
// 可使用的相关参数
// $request.headers, $request.body, $request.method, $request.hostname, $request.port, $request.path, $request.url
// $response.headers, $response.body, $response.statusCode

let body = $response.body
// let obj = JSON.parse(body)
if (/httpbin/.test($request.url)) {
  body += 'change by elecV2P' + body
}
$done({ body })
```

## 使用其他 nodejs module

在 JS 文件开头 **// @require** 声明， 然后直接调用

``` JS example
// @require          axios

axios.get('https://github.com/elecV2/elecV2P').then(res=>console.log(res.data))
```

*@require 的库必须是已经在当前项目安装好的*

1.8.6 更新：

- 支持 @require 本地 JS 文件

``` JS example
// @require       ./requireob.js
// 对应的变量为 requireob， 内容为 requireob.js 的 export

requireob('hello elecV2P')      // 直接调用 requireob.js 的 export

// --- example 2 ---
// 支持同时多个调用
// @require     ./requireob, ./requireob2.js

requireob('hello elecV2P')
console.log(requireob2)
```

*@require 本地文件以 **./** 开头，相对目录为 script/JSFile*

## 运行结果 - $result

优先级： $result/$done > JS 最后一条语句结果

``` JS example
let elecV2P = 'customize personal network'
elecV2P
// 返回字符串 'customize personal network'

let elecV2P = 'customize personal network'
$done(elecV2P)
elecV2P
// 返回一个对象 {body: 'customize personal network'}
// $done 函数会强制将字符串转化为 {body: 'string'} 对象输出
// $done(object) - 原样输出
// $done() - 输出空对象 {}

let elecV2P = 'customize personal network'
$done({ response: elecV2P })
// 返回对象 {response: 'customize personal network'}

let elecV2P = 'customize personal network'
$done({ response: elecV2P })
$result = 'customize personal network'
let other = 'other code'
console.log(other)
// 返回字符串 'customize personal network'
// 后面的 console 语句会执行完成

let elecV2P = 'customize personal network'
$done({ response: elecV2P })
$result = 'customize personal network'
let other = 'other code'
$done(other)
console.log($result)
// 返回结果 {body: 'other code'}
// console.log 结果： {"body": "other code"}
// $done 是将输入变量对象化之后赋值给 $result
```

## 远程 JS

远程 JS 可用于： rules/rewrite/task/webhook

``` 
// default.list
[elecV2P rules]
host,httpbin.org,js,https://raw.githubusercontent.com/elecV2/elecV2P/master/script/JSFile/0body.js,res

// rewrite.list
[elecV2P rewrite.list]
^https?:\/\/httpbin\.org/get\?/hello https://raw.githubusercontent.com/elecV2/elecV2P/master/script/JSFile/0body.js

// task
"taskuid": {
  "name": "任务名称",
  "type": "cron/schedule",        // 定时方式： cron 定时 / schedule 倒计时
  "time": "30 999 2 3",           // 定时时间，具体格式见 06-task.md
  "running": true,                // 任务运行状态
  "job": {                        // 具体执行任务
    "type": "runjs",              // 执行任务类型
    "target": "https://raw.githubusercontent.com/elecV2/elecV2P/master/script/JSFile/webhook.js",
  }
}

// webhook
http://127.0.0.1:12521/webhook?type=runjs&token=a8c259b2-67fe-xxxx-7bfdf1f55cb3&fn=https://raw.githubusercontent.com/elecV2/elecV2P/master/script/JSFile/webhook.js
```

## 模拟网络请求 - mock 

### 本地 fetch / 服务器 axios

模拟网络请求发起的位置

### HEADERS

第一项选择内容为 **Content-Type** 的值，后面附加内容为 headers 的其他值（严格的 JSON 格式）。

### BODY

textarea 区域为 request body 值，或作为直接返回的 response body。